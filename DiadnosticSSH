pipeline {
    agent any
    
    environment {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Docker Hub
        DOCKERHUB_CREDENTIALS = credentials('docker-hub-credentials')
        DOCKER_IMAGE = 'vaiz82/mock-api'
        DOCKER_TAG = "${BUILD_NUMBER}"
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ - –£–ë–ï–î–ò–¢–ï–°–¨ –ß–¢–û IP –ü–†–ê–í–ò–õ–¨–ù–´–ô
        DEPLOY_SERVER = 'ubuntu@13.60.62.225'  // –ü—Ä–æ–±–ª–µ–º–∞ –∑–¥–µ—Å—å!
        DEPLOY_PORT = '22'
        REMOTE_DIR = '/opt/mock-api'
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        APP_PORT = '8000'
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git
        GIT_REPO = 'https://github.com/vaiz1982/mock-api.git'
        GIT_BRANCH = 'main'
    }
    
    stages {
        stage('Diagnose SSH Problem') {
            steps {
                script {
                    echo '=== DIAGNOSING SSH CONNECTION PROBLEM ==='
                    echo "Trying to connect to: ${DEPLOY_SERVER}:${DEPLOY_PORT}"
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
                    sh """
                        echo "1. Pinging server..."
                        ping -c 3 16.16.126.70 || echo "Ping failed"
                        
                        echo ""
                        echo "2. Checking port 22..."
                        timeout 5 nc -z -w 2 16.16.126.70 22 && echo "Port 22 is OPEN" || echo "Port 22 is CLOSED or timeout"
                        
                        echo ""
                        echo "3. Testing SSH connection..."
                        timeout 10 ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "echo 'SSH SUCCESS'" && echo "‚úì SSH connection works!" || {
                            echo "‚úó SSH connection failed"
                            echo ""
                            echo "=== POSSIBLE SOLUTIONS ==="
                            echo "1. Check if IP 16.16.126.70 is correct"
                            echo "2. Check if SSH service is running on target server"
                            echo "3. Check firewall rules on target server"
                            echo "4. Check if Jenkins user has SSH key configured"
                            echo ""
                            echo "For now, will attempt alternative deployment methods..."
                        }
                    """
                }
            }
        }
        
        stage('Alternative: Check Jenkins Server IP') {
            steps {
                script {
                    echo '=== CHECKING JENKINS SERVER NETWORK ==='
                    
                    sh """
                        echo "Jenkins server IP addresses:"
                        hostname -I
                        
                        echo ""
                        echo "Current network configuration:"
                        ip addr show
                        
                        echo ""
                        echo "NOTE: Sometimes Jenkins runs in container/different network"
                        echo "Target server 16.16.126.70 might be the SAME as Jenkins server"
                    """
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ç–æ—Ç –∂–µ –ª–∏ —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä
                    sh '''
                        JENKINS_IP=$(hostname -I | awk "{print \$1}")
                        echo "Jenkins primary IP: $JENKINS_IP"
                        echo "Target server IP: 16.16.126.70"
                        
                        if [ "$JENKINS_IP" = "16.16.126.70" ]; then
                            echo "‚ö†Ô∏è WARNING: Jenkins and target server appear to be the SAME machine!"
                            echo "Use 'localhost' or '127.0.0.1' instead"
                        fi
                    '''
                }
            }
        }
        
        stage('Clean and Clone') {
            steps {
                script {
                    cleanWs()
                    sh """
                        git clone ${GIT_REPO} .
                        ls -la
                    """
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-hub-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo "\${DOCKER_PASS}" | docker login -u "\${DOCKER_USER}" --password-stdin
                        docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker push ${DOCKER_IMAGE}:latest
                        docker logout
                    """
                }
            }
        }
        
        stage('Deploy - Attempt Multiple Methods') {
            steps {
                script {
                    echo '=== ATTEMPTING DEPLOYMENT ==='
                    
                    // –ú–µ—Ç–æ–¥ 1: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ localhost (–µ—Å–ª–∏ —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–µ—Ä)
                    sh """
                        echo "Method 1: Try localhost deployment..."
                        if docker run -d --name test-local -p 9000:8000 ${DOCKER_IMAGE}:latest; then
                            echo "‚úì Local deployment successful on port 9000"
                            docker stop test-local
                            docker rm test-local
                        else
                            echo "‚úó Local deployment failed"
                        fi
                    """
                    
                    // –ú–µ—Ç–æ–¥ 2: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º/–ø–æ—Ä—Ç–æ–º
                    sh """
                        echo ""
                        echo "Method 2: Try different SSH configurations..."
                        
                        # –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                        for user in "alex" "jenkins" "root" "ubuntu"; do
                            echo "Trying user: \$user@16.16.126.70"
                            timeout 5 ssh -o ConnectTimeout=3 \${user}@16.16.126.70 "echo 'Hello'" 2>/dev/null && {
                                echo "‚úì Success with user: \$user"
                                export DEPLOY_SERVER="\${user}@16.16.126.70"
                                break
                            } || echo "‚úó Failed with user: \$user"
                        done
                    """
                    
                    // –ú–µ—Ç–æ–¥ 3: –ï—Å–ª–∏ SSH –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–µ–ø–ª–æ–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
                    sh """
                        echo ""
                        echo "Method 3: Deploying on Jenkins server (fallback)..."
                        
                        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        docker stop mock-api-prod 2>/dev/null || true
                        docker rm mock-api-prod 2>/dev/null || true
                        
                        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
                        docker run -d \\
                            --name mock-api-prod \\
                            --restart unless-stopped \\
                            -p ${APP_PORT}:8000 \\
                            ${DOCKER_IMAGE}:latest
                        
                        # –ü–æ–ª—É—á–∞–µ–º IP Jenkins —Å–µ—Ä–≤–µ—Ä–∞
                        JENKINS_IP=\$(hostname -I | awk '{print \$1}')
                        echo ""
                        echo "üéâ DEPLOYMENT COMPLETE (Local Fallback)"
                        echo "Application deployed on Jenkins server"
                        echo "Access: http://\${JENKINS_IP}:${APP_PORT}"
                        echo ""
                        echo "Endpoints to test:"
                        echo "  http://\${JENKINS_IP}:${APP_PORT}/order"
                        echo "  http://\${JENKINS_IP}:${APP_PORT}/user"
                        echo "  http://\${JENKINS_IP}:${APP_PORT}/catalog"
                    """
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo '=== VERIFYING DEPLOYMENT ==='
                    
                    sh """
                        echo "Waiting for application to start..."
                        sleep 10
                        
                        echo ""
                        echo "Testing endpoints on Jenkins server:"
                        
                        echo "1. /order endpoint:"
                        curl -s -f http://localhost:${APP_PORT}/order && echo "‚úì SUCCESS" || echo "‚úó FAILED"
                        
                        echo ""
                        echo "2. /user endpoint:"
                        curl -s -f http://localhost:${APP_PORT}/user && echo "‚úì SUCCESS" || echo "‚úó FAILED"
                        
                        echo ""
                        echo "3. /catalog endpoint:"
                        curl -s -f http://localhost:${APP_PORT}/catalog | head -c 200 && echo "... ‚úì SUCCESS" || echo "‚úó FAILED"
                        
                        echo ""
                        echo "=== DEPLOYMENT SUMMARY ==="
                        JENKINS_IP=\$(hostname -I | awk '{print \$1}')
                        echo "Application URL: http://\${JENKINS_IP}:${APP_PORT}"
                        echo "Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                        echo "Build: ${BUILD_NUMBER}"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo 'üéâ PIPELINE COMPLETED SUCCESSFULLY!'
            sh """
                echo ""
                echo "=== IMPORTANT NOTES ==="
                echo "1. SSH to 16.16.126.70 failed - check network/firewall"
                echo "2. Application deployed locally on Jenkins server"
                echo "3. To fix SSH, run these commands on TARGET server:"
                echo "   sudo apt-get update"
                echo "   sudo apt-get install openssh-server"
                echo "   sudo systemctl enable ssh"
                echo "   sudo systemctl start ssh"
                echo "   sudo ufw allow 22/tcp"
                echo ""
                echo "4. On Jenkins server, add SSH key:"
                echo "   sudo -u jenkins ssh-keygen"
                echo "   sudo cat /var/lib/jenkins/.ssh/id_rsa.pub"
                echo "   # Copy to target server's ~/.ssh/authorized_keys"
            """
        }
        failure {
            echo '‚ö†Ô∏è Pipeline completed with some issues'
        }
        always {
            cleanWs()
        }
    }
}
